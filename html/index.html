<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <title>nchan WebSocket è®¢é˜… Demo</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 40px; }
        h1 { font-size: 24px; margin-bottom: 20px; }
        .box { background: #fff; border-radius: 8px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,.06); max-width: 480px; }
        .row { margin-bottom: 16px; }
        label { display: block; font-size: 14px; color: #666; margin-bottom: 4px; }
        input { width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 4px; font-size: 14px; }
        button { padding: 8px 16px; border: none; border-radius: 4px; font-size: 14px; cursor: pointer; }
        .btn-primary { background: #1890ff; color: #fff; }
        .btn-secondary { background: #52c41a; color: #fff; margin-left: 8px; }
        .btn-danger { background: #ff4d4f; color: #fff; margin-left: 8px; }
        #status { margin-top: 16px; font-size: 14px; }
        #log { margin-top: 16px; background: #fafafa; border: 1px solid #e6e6e6; border-radius: 4px; padding: 12px; height: 200px; overflow: auto; font-size: 13px; color: #333; }
        .msg { margin: 4px 0; }
        .msg-time { color: #999; margin-right: 8px; }
        .msg-info { color: #333; }
        .msg-success { color: #52c41a; }
        .msg-warning { color: #faad14; }
        .msg-error { color: #ff4d4f; }
        .send-row { display: flex; gap: 8px; margin-top: 24px; }
        .send-row input { flex: 1; }
        .send-row button { flex-shrink: 0; }
    </style>
</head>
<body>
<div class="box">
    <h1>nchan WebSocket è®¢é˜… Demo</h1>
    <div class="row">
        <label>ç”¨æˆ· UID</label>
        <input id="uid" placeholder="10086" value="10086" />
    </div>
    <div class="row">
        <label>å¹³å°ï¼ˆå¯¹åº” nginx æ­£åˆ™ï¼‰</label>
        <input id="platform" placeholder="customer" value="customer" />
    </div>
    <div class="row">
        <button id="connectBtn" class="btn-primary">è¿æ¥</button>
        <button id="disconnectBtn" class="btn-danger" disabled>æ–­å¼€</button>
    </div>

    <!-- æ·»åŠ æ¶ˆæ¯å‘é€åŒºåŸŸ -->
    <div class="send-row">
        <input id="messageInput" placeholder="è¾“å…¥è¦å‘é€çš„æ¶ˆæ¯..." disabled />
        <button id="sendBtn" class="btn-secondary" disabled>å‘é€</button>
    </div>

    <div id="status">çŠ¶æ€ï¼š<span id="statusText">æœªè¿æ¥</span></div>
    <div id="log"></div>
</div>

<script>
    const uidInp = document.getElementById('uid');
    const platformInp = document.getElementById('platform');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const statusText = document.getElementById('statusText');
    const logDiv = document.getElementById('log');

    let ws = null;
    let pingIntervalTimer = null;   // å‘é€pingçš„å®šæ—¶å™¨
    let pongTimeoutTimer = null;    // ç­‰å¾…pongå“åº”çš„è¶…æ—¶å®šæ—¶å™¨
    let reconnectTimer = null;      // é‡è¿å®šæ—¶å™¨
    let reconnectAttempts = 0;      // å½“å‰é‡è¿å°è¯•æ¬¡æ•°
    const maxReconnectAttempts = 5; // æœ€å¤§é‡è¿å°è¯•æ¬¡æ•°
    const baseReconnectDelay = 1000; // é‡è¿åŸºç¡€å»¶è¿Ÿæ—¶é—´(æ¯«ç§’)

    function print(msg, type = 'info') {
        console.log(msg)
        // const p = document.createElement('div');
        // p.className = `msg msg-${type}`;
        // p.innerHTML = `<span class="msg-time">${new Date().toLocaleTimeString()}</span> ${msg}`;
        // logDiv.appendChild(p);
        // logDiv.scrollTop = logDiv.scrollHeight;
    }

    // å¯åŠ¨å¿ƒè·³æ£€æµ‹
    function startHeartbeat() {
        stopHeartbeat(); // å…ˆæ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§å®šæ—¶å™¨
        // å¿ƒè·³é€»è¾‘ä¿æŒä¸å˜...
    }

    // åœæ­¢å¿ƒè·³æ£€æµ‹å’Œè¶…æ—¶æ£€æŸ¥
    function stopHeartbeat() {
        if (pingIntervalTimer) {
            clearInterval(pingIntervalTimer);
            pingIntervalTimer = null;
        }
        if (pongTimeoutTimer) {
            clearTimeout(pongTimeoutTimer);
            pongTimeoutTimer = null;
        }
    }

    // åœæ­¢é‡è¿å°è¯•
    function stopReconnect() {
        if (reconnectTimer) {
            clearTimeout(reconnectTimer);
            reconnectTimer = null;
        }
        reconnectAttempts = 0; // é‡ç½®é‡è¿å°è¯•æ¬¡æ•°
    }

    // åˆå§‹åŒ–é‡è¿æœºåˆ¶
    function scheduleReconnect() {
        stopReconnect(); // é˜²æ­¢å¤šä¸ªé‡è¿å®šæ—¶å™¨åŒæ—¶å­˜åœ¨

        if (reconnectAttempts >= maxReconnectAttempts) {
            print(`âŒ å·²è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•° (${maxReconnectAttempts})ï¼Œåœæ­¢é‡è¿ã€‚`, 'error');
            statusText.textContent = 'è¿æ¥å¤±è´¥ï¼ˆå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°ï¼‰';
            return;
        }

        // ä½¿ç”¨æŒ‡æ•°é€€é¿ç®—æ³•è®¡ç®—ä¸‹æ¬¡é‡è¿çš„å»¶è¿Ÿ
        const delay = baseReconnectDelay * Math.pow(2, reconnectAttempts);
        reconnectAttempts++;

        print(`â° å°†åœ¨ ${delay/1000} ç§’åå°è¯•ç¬¬ ${reconnectAttempts} æ¬¡é‡è¿...`, 'warning');
        statusText.textContent = `ç­‰å¾…é‡è¿ (${reconnectAttempts}/${maxReconnectAttempts})`;

        reconnectTimer = setTimeout(() => {
            print(`ğŸ”„ å¼€å§‹ç¬¬ ${reconnectAttempts} æ¬¡é‡è¿å°è¯•...`, 'info');
            connect();
        }, delay);
    }

    // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡ç«¯
    function sendMessage() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            print('âŒ è¿æ¥æœªå»ºç«‹ï¼Œæ— æ³•å‘é€æ¶ˆæ¯', 'error');
            return;
        }

        const message = messageInput.value.trim();
        if (!message) {
            print('âš ï¸ è¯·è¾“å…¥è¦å‘é€çš„æ¶ˆæ¯', 'warning');
            return;
        }

        try {
            // å°è¯•å‘é€æ¶ˆæ¯
            ws.send(message);
            print(`ğŸ“¤ >>> å‘é€æ¶ˆæ¯: ${message}`, 'success');
            messageInput.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
        } catch (error) {
            print(`âŒ å‘é€å¤±è´¥: ${error.message}`, 'error');
        }
    }

    // ç›‘å¬è¾“å…¥æ¡†å›è½¦é”®å‘é€
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    function connect() {
        const uid = uidInp.value.trim();
        const platform = platformInp.value.trim();
        if (!uid || !platform) return alert('è¯·è¾“å…¥ UID å’Œå¹³å°');

        // ä¸ nginx æ­£åˆ™åŒ¹é…ï¼š/sub/<platform>_<uid>
        const url = `ws://localhost:8080/sub/${platform}/${uid}`;
        // const url = `ws://192.168.1.17/meta_events/all`;
        print(`ğŸŒ æ­£åœ¨è¿æ¥ ${url} ...`, 'info');
        statusText.textContent = 'è¿æ¥ä¸­...';
        connectBtn.disabled = true;
        messageInput.disabled = true;
        sendBtn.disabled = true;

        // å…ˆæ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§è¿æ¥å’Œå¿ƒè·³
        if (ws) {
            ws.close();
        }
        stopHeartbeat();
        stopReconnect();

        ws = new WebSocket(url);
        ws.onopen = () => {
            statusText.textContent = 'å·²è¿æ¥';
            disconnectBtn.disabled = false;
            messageInput.disabled = false;
            sendBtn.disabled = false;
            print('âœ… WebSocket è¿æ¥æˆåŠŸ', 'success');
            reconnectAttempts = 0; // è¿æ¥æˆåŠŸæ—¶é‡ç½®é‡è¿å°è¯•æ¬¡æ•°
            startHeartbeat(); // è¿æ¥æˆåŠŸåå†å¯åŠ¨å¿ƒè·³
        };

        ws.onmessage = (e) => {
            try {
                // å°è¯•è§£æJSONæ¶ˆæ¯
                const data = JSON.parse(e.data);

                if (data.type === 'pong') {
                    // æ”¶åˆ°å¿ƒè·³å“åº”
                    print('âœ… <<< æ”¶åˆ°å¿ƒè·³å“åº” pong', 'success');
                    if (pongTimeoutTimer) {
                        clearTimeout(pongTimeoutTimer);
                        pongTimeoutTimer = null;
                    }
                } else {
                    // å…¶ä»–ä¸šåŠ¡æ¶ˆæ¯
                    print(`ğŸ“¨ <<< æ”¶åˆ°æ¶ˆæ¯: ${e.data}`, 'info');
                }
            } catch (err) {
                // éJSONæ¶ˆæ¯æˆ–è§£æå¤±è´¥
                print(`ğŸ“¨ <<< æ”¶åˆ°æ¶ˆæ¯: ${e.data}`, 'info');
            }
        };

        ws.onerror = (e) => {
            print('âŒ WebSocket è¿æ¥é”™è¯¯', 'error');
            // onerror åé€šå¸¸è¿˜ä¼šè§¦å‘ onclose
        };

        ws.onclose = (e) => {
            statusText.textContent = 'æœªè¿æ¥';
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
            messageInput.disabled = true;
            sendBtn.disabled = true;
            print(`ğŸ”Œ è¿æ¥å·²å…³é—­ (code: ${e.code}, reason: ${e.reason || 'æ— '})`, 'info');
            stopHeartbeat(); // è¿æ¥å…³é—­æ—¶åœæ­¢å¿ƒè·³

            // å¦‚æœä¸æ˜¯æ‰‹åŠ¨æ–­å¼€ï¼ˆæ¯”å¦‚ç‚¹å‡»æ–­å¼€æŒ‰é’®ï¼‰ï¼Œåˆ™å°è¯•é‡è¿
            if (e.code !== 1000) { // 1000 é€šå¸¸è¡¨ç¤ºæ­£å¸¸å…³é—­
                scheduleReconnect();
            } else {
                print('ğŸ‘‹ ç”¨æˆ·ä¸»åŠ¨æ–­å¼€è¿æ¥', 'info');
            }
        };
    }

    function disconnect() {
        // æ‰‹åŠ¨æ–­å¼€æ—¶ï¼Œæ¸…é™¤é‡è¿é€»è¾‘ï¼Œä½¿ç”¨æ­£å¸¸å…³é—­ä»£ç 
        stopReconnect();
        if (ws) {
            ws.close(1000, 'User intentionally disconnected');
        }
    }

    connectBtn.onclick = connect;
    disconnectBtn.onclick = disconnect;
    sendBtn.onclick = sendMessage;

    // é¡µé¢å…³é—­å‰ä¸»åŠ¨å…³é—­WebSocketè¿æ¥
    window.addEventListener('beforeunload', () => {
        if (ws) {
            ws.close(1000, 'Page closed');
        }
    });
</script>
</body>
</html>