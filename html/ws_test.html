<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <title>WebSocketæ¶ˆæ¯æ¨é€æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 20px;
            height: 100vh;
            overflow: hidden;
        }
        .container {
            display: flex;
            height: calc(100vh - 40px);
            gap: 20px;
        }
        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .right-panel {
            width: 300px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,.06);
            padding: 20px;
            overflow-y: auto;
        }
        .control-section {
            background: #fff;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,.06);
            margin-bottom: 16px;
        }
        .control-section h3 {
            margin: 0 0 12px 0;
            font-size: 16px;
            color: #333;
        }
        .row {
            margin-bottom: 12px;
        }
        .row:last-child {
            margin-bottom: 0;
        }
        label {
            display: block;
            font-size: 14px;
            color: #666;
            margin-bottom: 4px;
        }
        input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }
        .btn-primary { background: #1890ff; color: #fff; }
        .btn-danger { background: #ff4d4f; color: #fff; margin-left: 8px; }
        .btn-success { background: #52c41a; color: #fff; }
        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            margin-left: 8px;
        }
        .status-bar {
            background: #fff;
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,.06);
            margin-bottom: 16px;
            font-size: 14px;
        }
        .chat-boxes-container {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            overflow-y: auto;
            padding: 0 0 16px 0;
            min-height: 400px;
        }
        .chat-box {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,.06);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 300px;
        }
        .chat-header {
            background: #fafafa;
            padding: 12px 16px;
            border-bottom: 1px solid #e6e6e6;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chat-title {
            font-weight: 500;
            color: #333;
            flex: 1;
        }
        .connection-status {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            background: #f0f0f0;
            color: #666;
        }
        .connection-status.connected {
            background: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }
        .connection-status.connecting {
            background: #fff7e6;
            color: #fa8c16;
            border: 1px solid #ffd591;
        }
        .chat-box .chat-messages {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
            background: #fff;
            min-height: 200px;
        }
        .message {
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
        }
        .message.self {
            justify-content: flex-end;
        }
        .message-content {
            max-width: 70%;
            padding: 8px 12px;
            border-radius: 8px;
            word-wrap: break-word;
        }
        .message.self .message-content {
            background: #1890ff;
            color: #fff;
        }
        .message.other .message-content {
            background: #f0f0f0;
            color: #333;
        }
        .message.system .message-content {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            max-width: 80%;
        }
        .message-user {
            font-size: 12px;
            margin-bottom: 4px;
            color: #666;
        }
        .message-text {
            font-size: 14px;
            line-height: 1.4;
        }
        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
        }
        .online-users {
            margin-bottom: 16px;
        }
        .online-users h3 {
            margin: 0 0 12px 0;
            font-size: 16px;
            color: #333;
        }
        .user-item {
            background: #fafafa;
            border: 1px solid #e6e6e6;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
        }
        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .user-id {
            font-weight: 500;
            color: #333;
        }
        .user-status {
            display: flex;
            align-items: center;
            font-size: 12px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 4px;
        }
        .status-online {
            background: #52c41a;
        }
        .status-offline {
            background: #d9d9d9;
        }
        .user-controls {
            display: flex;
            gap: 8px;
        }
        .user-controls input {
            flex: 1;
        }
        .log {
            margin-top: 16px;
            background: #fafafa;
            border: 1px solid #e6e6e6;
            border-radius: 4px;
            padding: 12px;
            height: 120px;
            overflow: auto;
            font-size: 12px;
            color: #333;
        }
        .msg {
            margin: 2px 0;
        }
        .msg-time {
            color: #999;
            margin-right: 8px;
            font-size: 11px;
        }
        .msg-info { color: #333; }
        .msg-success { color: #52c41a; }
        .msg-warning { color: #faad14; }
        .msg-error { color: #ff4d4f; }
    </style>
</head>
<body>
<div class="container">
    <div class="left-panel">
        <div class="status-bar">
            WebSocket èŠå¤©ç³»ç»Ÿ
        </div>



        <div class="log" id="log"></div>
    </div>

    <div class="right-panel">
        <div class="online-users">
            <h3>åœ¨çº¿ç”¨æˆ·</h3>
            <div id="onlineUsersList">
                <!-- åŠ¨æ€ç”Ÿæˆåœ¨çº¿ç”¨æˆ·åˆ—è¡¨ -->
            </div>
        </div>
    </div>
</div>

<script>
    const logDiv = document.getElementById('log');
    const onlineUsersListElement = document.getElementById('onlineUsersList');

    // èŠå¤©ç›¸å…³æ•°æ®
    let chatHistory = {}; // å­˜å‚¨èŠå¤©å†å²ï¼Œæ ¼å¼: { userId: [messages] }
    let webSocketConnections = {}; // å­˜å‚¨å¤šä¸ªWebSocketè¿æ¥ï¼Œæ ¼å¼: { userId: ws }
    let onlineUsersList = []; // ä»APIè·å–çš„åœ¨çº¿ç”¨æˆ·åˆ—è¡¨

    // é»˜è®¤åˆ›å»º4ä¸ªèŠå¤©æ¡†ç”¨æˆ·
    const defaultChatUsers = [
        { uid: '10086', platform: 'customer' },
        { uid: '10087', platform: 'customer' },
        { uid: '10088', platform: 'customer' },
        { uid: '10089', platform: 'customer' }
    ];

    function print(msg, type = 'info') {
        const p = document.createElement('div');
        p.className = `msg msg-${type}`;
        p.innerHTML = `<span class="msg-time">${new Date().toLocaleTimeString()}</span> ${msg}`;
        logDiv.appendChild(p);
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    // åˆå§‹åŒ–èŠå¤©ç•Œé¢
    function initChatInterface() {
        // åˆ›å»ºå¤šä¸ªç‹¬ç«‹çš„èŠå¤©æ¡†
        createMultipleChatBoxes();

        // åˆå§‹åŒ–èŠå¤©å†å²
        defaultChatUsers.forEach(user => {
            if (!chatHistory[user.uid]) {
                chatHistory[user.uid] = [];
            }
        });
    }

    // åˆ›å»ºå¤šä¸ªèŠå¤©æ¡†
    function createMultipleChatBoxes() {
        // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨èŠå¤©æ¡†å®¹å™¨
        let chatBoxesContainer = document.querySelector('.chat-boxes-container');

        if (chatBoxesContainer) {
            // å¦‚æœå·²å­˜åœ¨ï¼Œå…ˆæ¸…ç©º
            chatBoxesContainer.innerHTML = '';
        } else {
            // åˆ›å»ºæ–°çš„èŠå¤©æ¡†å®¹å™¨
            chatBoxesContainer = document.createElement('div');
            chatBoxesContainer.className = 'chat-boxes-container';

            // æ’å…¥åˆ°çŠ¶æ€æ åé¢
            const statusBar = document.querySelector('.status-bar');
            statusBar.parentNode.insertBefore(chatBoxesContainer, statusBar.nextSibling);
        }

        // ä¸ºæ¯ä¸ªç”¨æˆ·åˆ›å»ºç‹¬ç«‹çš„èŠå¤©æ¡†
        defaultChatUsers.forEach((user, index) => {
            const chatBox = document.createElement('div');
            chatBox.className = 'chat-box';
            chatBox.dataset.userId = user.uid;
            chatBox.innerHTML = `
                <div class="chat-header">
                    <span class="chat-title">ç”¨æˆ· ${user.uid}</span>
                    <span class="connection-status" id="status-${user.uid}">æœªè¿æ¥</span>
                    <button class="btn-small btn-primary" onclick="connectUser('${user.uid}', '${user.platform}')">è¿æ¥</button>
                    <button class="btn-small btn-danger" onclick="disconnectUser('${user.uid}')">æ–­å¼€</button>
                </div>
                <div class="chat-messages" id="messages-${user.uid}">
                    <!-- æ¶ˆæ¯å†…å®¹ -->
                </div>
            `;
            chatBoxesContainer.appendChild(chatBox);
        });
    }



    // æ·»åŠ æ¶ˆæ¯åˆ°æŒ‡å®šç”¨æˆ·èŠå¤©æ¡†çš„UI
    function addMessageToUI(msg, userId) {
        console.log(`å°è¯•æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©æ¡† ${userId}:`, msg);

        const messagesContainer = document.getElementById(`messages-${userId}`);
        if (!messagesContainer) {
            console.error(`æ‰¾ä¸åˆ°æ¶ˆæ¯å®¹å™¨: messages-${userId}`);
            return;
        }

        console.log(`æ‰¾åˆ°æ¶ˆæ¯å®¹å™¨ï¼Œå‡†å¤‡æ·»åŠ æ¶ˆæ¯`);

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${msg.type}`;

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';

        let userLabel = '';
        if (msg.type === 'self') {
            userLabel = 'æˆ‘è‡ªå·±';
        } else if (msg.type === 'system') {
            userLabel = 'ç³»ç»Ÿæ¶ˆæ¯';
        } else {
            userLabel = `ç”¨æˆ· ${userId}`;
        }

        contentDiv.innerHTML = `
            ${msg.type !== 'system' ? `<div class="message-user">${userLabel}</div>` : ''}
            <div class="message-text">${msg.event_msg}</div>
            <div class="message-time">${new Date(msg.timestamp).toLocaleTimeString()}</div>
        `;

        messageDiv.appendChild(contentDiv);
        messagesContainer.appendChild(messageDiv);

        console.log(`æ¶ˆæ¯å·²æ·»åŠ åˆ°èŠå¤©æ¡† ${userId}`);

        // æ»šåŠ¨åˆ°åº•éƒ¨
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // å¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯
    function handleReceivedMessage(data, userId) {
        console.log(`å¤„ç†ç”¨æˆ· ${userId} çš„æ¶ˆæ¯:`, data);

        const message = {
            ...data,
            timestamp: Date.now(),
            type: data.event_type === 'system' ? 'system' : 'other'
        };

        // å­˜å‚¨æ¶ˆæ¯å†å²
        if (!chatHistory[userId]) {
            chatHistory[userId] = [];
        }
        chatHistory[userId].push(message);

        // åªæ˜¾ç¤ºåœ¨å¯¹åº”çš„èŠå¤©æ¡†ä¸­
        addMessageToUI(message, userId);

        print(`ğŸ“¨ ç”¨æˆ· ${userId} æ”¶åˆ°æ¶ˆæ¯: ${data.event_msg}`, 'info');
    }

    // è·å–åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
    async function fetchOnlineUsers() {
        useMockOnlineUsers();
    }

    // ä½¿ç”¨mockæ•°æ®
    function useMockOnlineUsers() {
        onlineUsersList = [
            { id: '10086', name: 'ç”¨æˆ·10086' },
            { id: '10087', name: 'ç”¨æˆ·10087' },
            { id: '10088', name: 'ç”¨æˆ·10088' },
            { id: '10089', name: 'ç”¨æˆ·10089' }
        ];
        updateOnlineUsersList();
    }

    // æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨UI
    function updateOnlineUsersList() {
        const container = document.getElementById('onlineUsersList');
        if (!container) return;

        container.innerHTML = '';

        if (onlineUsersList.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #999;">æš‚æ— åœ¨çº¿ç”¨æˆ·</p>';
            return;
        }

        onlineUsersList.forEach(user => {
            const userDiv = document.createElement('div');
            userDiv.className = 'user-item';

            userDiv.innerHTML = `
                <div class="user-header">
                    <span class="user-id">${user.name} (ID: ${user.id})</span>
                    <div class="user-status">
                        <span class="status-dot status-online"></span>
                        <span>åœ¨çº¿</span>
                    </div>
                </div>
                <div class="user-controls">
                    <input type="text" id="msgInput-${user.id}" placeholder="è¾“å…¥æ¶ˆæ¯..." />
                    <button class="btn-success btn-small" onclick="sendMessageToUser('${user.id}')">å‘é€</button>
                </div>
            `;

            container.appendChild(userDiv);
        });
    }

    // å‘é€æ¶ˆæ¯ç»™æŒ‡å®šç”¨æˆ·ï¼ˆæ¨¡æ‹Ÿç³»ç»Ÿå‘é€ï¼‰
    async function sendMessageToUser(toUser) {
        const msgInput = document.getElementById(`msgInput-${toUser}`);
        const message = msgInput.value.trim();

        if (!message) return;

        print(`ğŸ“¤ æ¨¡æ‹Ÿç³»ç»Ÿå‘é€æ¶ˆæ¯ç»™ç”¨æˆ· ${toUser}: ${message}`, 'info');

        // ç«‹å³æ¸…ç©ºè¾“å…¥æ¡†
        msgInput.value = '';

        // å…ˆåœ¨æœ¬åœ°æ˜¾ç¤ºæ¶ˆæ¯ï¼ˆç”¨äºæµ‹è¯•ï¼‰
        const simulatedMessage = {
            event_type: 'system',
            event_msg: message,
            from_user: null,
            to_users: toUser
        };
        console.log(`æ¨¡æ‹Ÿæ¶ˆæ¯å‘é€ç»™ç”¨æˆ· ${toUser}:`, simulatedMessage);
        // handleReceivedMessage(simulatedMessage, toUser);

        try {
            const response = await fetch('http://localhost:8881/api/ws/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    platform: "customer",
                    to_users: [toUser],
                    message: message
                })
            });

            if (response.ok) {
                print(`âœ… æ¶ˆæ¯å‘é€æˆåŠŸ: ${toUser} - ${message}`, 'success');
            } else {
                print(`âŒ æ¶ˆæ¯å‘é€å¤±è´¥: ${response.statusText}`, 'error');
            }
        } catch (error) {
            print(`âŒ å‘é€è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
        }
    }

    // è¿æ¥æŒ‡å®šç”¨æˆ·
    function connectUser(userId, platform) {
        if (webSocketConnections[userId]) {
            print(`ç”¨æˆ· ${userId} å·²ç»è¿æ¥`, 'warning');
            return;
        }

        // ä¸ nginx æ­£åˆ™åŒ¹é…ï¼š/sub/<platform>_<uid>
        const url = `ws://localhost:8080/sub/${platform}/${userId}`;
        print(`ğŸŒ ç”¨æˆ· ${userId} æ­£åœ¨è¿æ¥ ${url} ...`, 'info');

        // æ›´æ–°è¿æ¥çŠ¶æ€
        const statusElement = document.getElementById(`status-${userId}`);
        if (statusElement) {
            statusElement.textContent = 'è¿æ¥ä¸­...';
            statusElement.className = 'connection-status connecting';
        }

        const ws = new WebSocket(url);
        webSocketConnections[userId] = ws;

        ws.onopen = () => {
            print(`âœ… ç”¨æˆ· ${userId} WebSocket è¿æ¥æˆåŠŸ`, 'success');

            // æ›´æ–°è¿æ¥çŠ¶æ€
            const statusElement = document.getElementById(`status-${userId}`);
            if (statusElement) {
                statusElement.textContent = 'å·²è¿æ¥';
                statusElement.className = 'connection-status connected';
            }

            // æ·»åŠ è¿æ¥æˆåŠŸæ¶ˆæ¯
            const connectMsg = {
                event_type: 'system',
                event_msg: `ç”¨æˆ· ${userId} å·²è¿æ¥`,
                from_user: null,
                to_user: userId
            };
            handleReceivedMessage(connectMsg, userId);
        };

        ws.onmessage = (e) => {
            try {
                // å°è¯•è§£æJSONæ¶ˆæ¯
                const data = JSON.parse(e.data);
                console.log(`ç”¨æˆ· ${userId} æ”¶åˆ°çš„åŸå§‹æ•°æ®:`, data);

                // ç¡®ä¿æ¶ˆæ¯æœ‰æ­£ç¡®çš„å­—æ®µ
                const processedData = {
                    event_type: data.event_type || 'message',
                    event_msg: data.event_msg || data.message || JSON.stringify(data),
                    from_user: data.from_user || data.from,
                    to_user: data.to_user || data.to || userId
                };

                handleReceivedMessage(processedData, userId);
            } catch (err) {
                // éJSONæ¶ˆæ¯æˆ–è§£æå¤±è´¥
                print(`ğŸ“¨ ç”¨æˆ· ${userId} æ”¶åˆ°éJSONæ¶ˆæ¯: ${e.data}`, 'info');
                // å°è¯•ä½œä¸ºæ™®é€šæ–‡æœ¬å¤„ç†
                const textData = {
                    event_type: 'message',
                    event_msg: e.data,
                    from_user: null,
                    to_user: userId
                };
                handleReceivedMessage(textData, userId);
            }
        };

        ws.onerror = (e) => {
            print(`âŒ ç”¨æˆ· ${userId} WebSocket è¿æ¥é”™è¯¯`, 'error');
        };

        ws.onclose = (e) => {
            print(`ğŸ”Œ ç”¨æˆ· ${userId} è¿æ¥å·²å…³é—­ (code: ${e.code}, reason: ${e.reason || 'æ— '})`, 'info');

            // æ›´æ–°è¿æ¥çŠ¶æ€
            const statusElement = document.getElementById(`status-${userId}`);
            if (statusElement) {
                statusElement.textContent = 'æœªè¿æ¥';
                statusElement.className = 'connection-status';
            }

            // æ¸…ç†è¿æ¥
            delete webSocketConnections[userId];

            // æ·»åŠ æ–­å¼€è¿æ¥æ¶ˆæ¯
            const disconnectMsg = {
                event_type: 'system',
                event_msg: `ç”¨æˆ· ${userId} è¿æ¥å·²æ–­å¼€`,
                from_user: null,
                to_user: userId
            };
            handleReceivedMessage(disconnectMsg, userId);
        };
    }

    // æ–­å¼€æŒ‡å®šç”¨æˆ·è¿æ¥
    function disconnectUser(userId) {
        if (webSocketConnections[userId]) {
            webSocketConnections[userId].close(1000, 'User disconnected');
            delete webSocketConnections[userId];
            print(`ğŸ‘‹ ç”¨æˆ· ${userId} ä¸»åŠ¨æ–­å¼€è¿æ¥`, 'info');
        }
    }

    // è¿æ¥æ‰€æœ‰é»˜è®¤ç”¨æˆ·
    function connectAllUsers() {
        defaultChatUsers.forEach(user => {
            connectUser(user.uid, user.platform);
        });
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ‰€æœ‰å†…å®¹
    window.addEventListener('load', () => {
        initChatInterface();
        useMockOnlineUsers();
        connectAllUsers();
    });

    // é¡µé¢å…³é—­å‰ä¸»åŠ¨å…³é—­æ‰€æœ‰WebSocketè¿æ¥
    window.addEventListener('beforeunload', () => {
        Object.keys(webSocketConnections).forEach(userId => {
            if (webSocketConnections[userId]) {
                webSocketConnections[userId].close(1000, 'Page closed');
            }
        });
    });
</script>
</body>
</html>